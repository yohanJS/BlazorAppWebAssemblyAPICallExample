@page "/nasaapi"
@using BlazorAppWebAssembly.Models
@inject HttpClient client

<PageTitle>NASA API</PageTitle>


<div class="container mb-3">
    <div class="row justify-content-center">
        <div class="col-md-6 border border-2 p-3 rounded bg-light">
            <h4 class="mt-3 mb-3">Start finding photos of Mars</h4>
            <p>Curiosity, Opportunity, and Spirit</p>
            <form>
                <div class="mb-3">
                    <label class="form-label">Rover name</label>
                    <input type="text" class="form-control" placeholder="Curiosity, Opportunity, and Spirit" @bind-value="@roverName" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Sol number</label>
                    <input type="text" class="form-control" placeholder="Search by sol (1, 5, 25).." @bind-value="@solNumber" />
                </div>
                <button type="button" class="btn btn-outline-info btn-block mb-3" @onclick="Search">Search</button>
                <button type="button" class="btn btn-outline-danger btn-block mb-3" @onclick="ClearFields">Reset</button>
                <br />
                <span class="alert-danger rounded m-1" role="alert">@roverNameEmpty</span>
                <br />
                <span class="alert-danger rounded m-1" role="alert">@solNumberEmpty</span>
            </form>
        </div>
    </div>
</div>


@if (response == null)
{
    <div class="row justify-content-center">
        <div class="col-md-6">
            <p class="alert alert-danger" role="alert">@userMessage</p>
        </div>
    </div>
}
else
{
    @if (response.rover != null)
    {
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Attribute</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Camera</td>
                    @if (response.camera != null)
                    {
                        <td>@response.camera.full_name</td>
                    }
                </tr>
                <tr>
                    <td>Earth date</td>
                    <td>@response.earth_date</td>
                </tr>
                <tr>
                    <td>Rover name</td>
                    <td>@response.rover.name</td>
                </tr>
                <tr>
                    <td>Landing date</td>
                    <td>@response.rover.landing_date</td>
                </tr>
                <tr>
                    <td>Launch date</td>
                    <td>@response.rover.launch_date</td>
                </tr>
                <tr>
                    <td>Total photos</td>
                    <td>@response.rover.total_photos</td>
                </tr>
            </tbody>
        </table>
        <div class="accordion" id="camerasAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="camerasHeader">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#camerasCollapse" aria-expanded="true" aria-controls="camerasCollapse">
                        Rover's Cameras
                    </button>
                </h2>
                <div id="camerasCollapse" class="accordion-collapse collapse" aria-labelledby="camerasHeader" data-bs-parent="#camerasAccordion">
                    <div class="accordion-body">
                        <ul>
                            @if (response.rover.cameras != null)
                            {
                                foreach (var camera in response.rover.cameras)
                                {
                                    <li class="list-group">@camera.full_name</li>
                                }
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-3">
            <div class="row justify-content-center">
                <div class="col-12">
                    <img src="@response.img_src" class="img-fluid border border-primary p-3" alt="Sample photo taken with a camera on Mars">
                    @if (response.camera != null)
                    {
                        <p>Sample photo taken with @response.camera.full_name</p>
                    }
                </div>
            </div>
        </div>
    }
}

@code {

    Photos? response = new Photos();
    public string roverName = string.Empty;
    public string? solNumber = string.Empty;
    public string roverNameEmpty = string.Empty;
    public string? solNumberEmpty = string.Empty;

    public string baseUri = "https://api.nasa.gov/mars-photos/api/v1/rovers/";
    public string apiKey = "9hImHQqhXffBiL6d3Cw7el1PeHUbYflXUjmnW7wS";

    public string errorMessage = string.Empty;
    public string userMessage = "No data found. Try another Sol.";

    private async Task Search()
    {
        // Reset error messages
        roverNameEmpty = string.Empty;
        solNumberEmpty = string.Empty;

        if (string.IsNullOrEmpty(roverName))
        {
            roverNameEmpty = "A Rover name must be entered.";
        }

        if (string.IsNullOrEmpty(solNumber))
        {
            solNumberEmpty = "A Sol number must be entered.";
        }

        // Check if there are any validation errors
        if (string.IsNullOrEmpty(roverNameEmpty) && string.IsNullOrEmpty(solNumberEmpty))
        {
            try
            {
                HttpClient client = new HttpClient();
                var url = $"{baseUri}{roverName}/photos?sol={solNumber}&api_key={apiKey}";

                NasaPhotoModel? AllData = new NasaPhotoModel();
                AllData = await client.GetFromJsonAsync<NasaPhotoModel>(url);

                if (AllData != null && AllData.photos != null)
                {
                    response = AllData.photos.FirstOrDefault();
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                errorMessage = ex.Message;
                StateHasChanged();
            }
        }
    }
    private void ClearFields()
    {
        roverName = string.Empty;
        solNumber = string.Empty;
        roverNameEmpty = string.Empty;
        solNumberEmpty = string.Empty;
    }
}

